import { ArticleLayout } from '@/components/ArticleLayout'

export const article = {
  author: 'Andrew Wilkinson',
  date: '2024-04-15',
  title: 'Building an Automated Trading System',
  description:
    'How I built a working automated trading bot for long/short positions on Hyperliquid in 48 hours with Claude AI, TypeScript, and Firebase.',
}

export const metadata = {
  title: article.title,
  description: article.description,
}

export default (props) => <ArticleLayout article={article} {...props} />

## Introduction

<div className="lead-paragraph mb-8 text-lg text-zinc-600 dark:text-zinc-400">
Automation is a cornerstone of trading activity within DeFi, with examples of this being active liquidity management, arbitrage opportunities between AMMs, yield position compounding, and active trading strategies. I've been having fun tinkering away with <a href="https://claude.ai" className="text-teal-600 dark:text-teal-400 hover:underline">claude.ai</a> lately and wanted to see if I could build something a little more interesting in a couple of days and write about my experience.
</div>

<div className="space-y-4">
  <p>So, I had an idea of what I wanted to do: automate the winding up and down of a <strong>long/short portfolio</strong> based on a custom strategy that can be iterated over time. I had a high-level architecture in mind and a familiar tech stack, as I wanted to understand the generated code for tweaking purposes; aside from that, I aimed to see how far I could get with <strong>Claude</strong>.</p>

  <div className="bg-teal-50 dark:bg-teal-900/20 border-l-4 border-teal-500 dark:border-teal-400 p-4 my-6 rounded-r-md">
    <p className="text-teal-700 dark:text-teal-300">Fast-forward to the fruits of the effort, and within 48 hours, we have a live deployed automated trading bot loaded up with $500 currently winding up and down a long/short portfolio on the DEX, <a href="https://hyperliquid.xyz/" className="text-teal-600 dark:text-teal-400 hover:underline">Hyperliquid</a>, and a production website to monitor the portfolio and its live positions.</p>
  </div>

  <p>Now, let's go into the journey of building it before, and at the end, I'll give my thoughts and insights on the experience of AI-assisted development and how I plan to go further with the project.</p>

  <p className="bg-zinc-100 dark:bg-zinc-800 p-3 rounded-md italic text-zinc-600 dark:text-zinc-400 text-sm">Note: This is just an amateur trading setup for fun using tech I'm familiar with and experimenting with AI; you probably won't see this in the real world, and the strategy itself is probably going to lose money over time ðŸ˜‚</p>
</div>

## Architecture Overview

The system developed focuses on a modular architecture consisting of several key components executed sequentially every 24 hours by an orchestrator function that coordinates the entire trading cycle. The complete cycle takes under 20 seconds from the beginning to the end to execute and has not only the built-in scalability that comes with Firebase's cloud infrastructure but also incorporates custom logic to make the system as fault-tolerant as possible.

<figure className="flex flex-col items-center my-8">
  <img src="/images/articles/trading-system/system-architecture.png" alt="System Architecture Diagram" className="rounded-lg shadow-md w-full max-w-3xl" />
  <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">System Architecture</figcaption>
</figure>

### Technology Stack

1. **Backend:**
   - Language: TypeScript
   - Cloud Platform: Firebase
   - Serverless Functions: Firebase Cloud Functions
   - Database: Cloud Firestore
   - Scheduled Tasks: Cloud Scheduler (via Firebase Functions)

2. **Frontend:**
   - Framework: React
   - State Management: React Hooks and Context API
   - Real-time Updates: Firestore Real-time Listeners

3. **Integrations:**
   - Hyperliquid Exchange
   - CCXT (Exchange API)
   - CoinGecko API

### Execution Flow

The trading cycle is executed every 24 hours and completes in under 20 seconds:

1. Cloud Scheduler triggers the Orchestrator function
2. The orchestrator checks the configuration and initiates the cycle
3. Market data is fetched and processed
4. Trading decisions are made based on the implemented strategy
5. Positions are adjusted (opened/closed) as needed
6. Portfolio metrics are updated
7. Frontend components react to data changes and update the UI

This architecture allows for easy future maintainability and extendability by simply adding new modules to the strategy to be executed by the orchestrator.

## Components and Their Roles

### 1. Configuration Management

**Purpose:** Controls the activation of the trading cycle and holds parameters that can be changed during runtime without redeployment.

**Implementation:** A Firestore document with an active flag, max positions, and trade size fields. The orchestrator reads this configuration at the start of each cycle to determine whether to proceed.

<figure className="flex flex-col items-center my-6">
  <img src="/images/articles/trading-system/config-retrieval.png" alt="Configuration Retrieval" className="rounded-lg shadow-md w-full max-w-3xl" />
  <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Configuration Retrieval Process</figcaption>
</figure>

### 2. Orchestrator

**Purpose:** A Firebase Cloud Function is scheduled to run every 24 hours and acts as the central controller for the entire trading system, managing the flow of operations and data between various components.

**Implementation:**

1. Initiates the trading cycle at a predetermined time each day.
2. Checks the configuration to ensure the system is active and retrieves current parameters.
3. Sequentially calls each component in the trading process:
   - Closes existing positions
   - Fetches fresh market data
   - Processes the data and calculates necessary indicators
   - Determines optimal trading pairs
   - Executes new trades based on the strategy
   - Updates the database with new positions and trade history
4. Handles error logging and notifications if any part of the process fails.
5. Performs cleanup operations to prepare for the next cycle.

<figure className="flex flex-col items-center my-6">
  <img src="/images/articles/trading-system/execution-function.png" alt="Execution Function Code" className="rounded-lg shadow-md w-full max-w-3xl" />
  <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Orchestrator Execution Function</figcaption>
</figure>

### 3. Position Management

**Purpose:** Ensures that all existing positions are closed before starting a new trading cycle. The strategy revolves around historical performance and keeping a balanced long/short portfolio, so we start with a clean slate each time based on new data.

**Implementation:** A function closeAllPositions that fetches all open positions on the exchange and starts closing them sequentially by calling the Hyperliquid API with retry mechanisms.

<figure className="flex flex-col items-center my-6">
  <img src="/images/articles/trading-system/position-closure.png" alt="Position Closure Function Code" className="rounded-lg shadow-md w-full max-w-3xl" />
  <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Position Closure Implementation</figcaption>
</figure>

### 4. Data Collection

**Purpose:** Gathers the latest market data required for making trading decisions.

**Implementation:** An API call to CoinGecko fetches recent market data for a whitelisted array of tokens. The whitelist is a mapping between Hyperliquid exchange-supported tokens and CoinGecko API IDs. We then store that data in Firestore for further processing later.

<figure className="flex flex-col items-center my-6">
  <img src="/images/articles/trading-system/fetch-market-data.png" alt="Fetch Market Data Function Code" className="rounded-lg shadow-md w-full max-w-3xl" />
  <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Market Data Collection Function</figcaption>
</figure>

### 5. Data Processing

**Purpose:** A function that processes the collected data to generate actionable insights we can use to create long/short trading pairs. This can be extended into as many components as we want by design.

**Implementation:** Various functions that analyse the market data and compute critical indicators to determine potential trading opportunities. This is done by a simple algorithm essentially playing around with recent price performance and project capitalisation.

### 6. Trading Pair Determination

**Purpose:** Selects optimal trading pairs based on processed data. We have set the maximum amount of long/short trading pairs to 10 in our system, but we often get around 20+ generated opportunities. Based on our data, this function determines the trading pairs that are objectively the best trades.

**Implementation:** A strict filtering function that applies selection criteria to the output of the data processing step and returns ten finalised trading pairs for execution.

### 7. Trade Execution

**Purpose:** Executes trades on the Hyperliquid exchange platform based on the finalised long/short trading pairs.

**Implementation:** An execution function that places orders, implements rate limiting, and handles retry logic to ensure trades are executed successfully. Finally, we record our executed trades to our Firestore for use on our front-end application.

<figure className="flex flex-col items-center my-6">
  <img src="/images/articles/trading-system/dashboard.png" alt="Trading Dashboard Interface" className="rounded-lg shadow-md w-full max-w-3xl" />
  <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Trading Dashboard UI</figcaption>
</figure>

### 9. Cleanup & Finalise

**Purpose:** Takes a snapshot of our total portfolio value and cycle duration after all the trade cycle steps are complete and clears temporary data to ensure the subsequent trading cycle starts fresh.

**Implementation:** Deletes specific Firestore collections, preventing data from previous cycles from affecting new ones and ensuring data integrity. The snapshot of the total portfolio value is a simple call to the Hyperliquid exchange to query our account, retrieving essential information such as current balances and margins used for our front-end display.

<div className="grid grid-cols-1 md:grid-cols-2 gap-6 my-6">
  <figure className="flex flex-col items-center">
    <img src="/images/articles/trading-system/cleanup-functions.png" alt="Cleanup Functions Code" className="rounded-lg shadow-md w-full" />
    <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Cleanup Functions</figcaption>
  </figure>
  <figure className="flex flex-col items-center">
    <img src="/images/articles/trading-system/portfolio-value.png" alt="Portfolio Value Function Code" className="rounded-lg shadow-md w-full" />
    <figcaption className="text-sm text-center text-zinc-600 dark:text-zinc-400 mt-2">Portfolio Value Tracking</figcaption>
  </figure>
</div>

## Conclusion and Future Directions

<div className="my-6 p-6 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl shadow-sm">
Building this system with AI has been very fun, although not without its challenges. In just 48 or so hours, we've created a functional, live-deployed trading bot that's actively managing a long/short portfolio on **Hyperliquid**. The system's modular architecture, built on a robust tech stack, allows for easy maintenance and future enhancements.
</div>

<h3 className="text-xl font-bold text-zinc-800 dark:text-zinc-200 mt-8 mb-4">Key Learnings</h3>

<div className="space-y-6">
  <div className="p-4 border-l-4 border-teal-500 bg-teal-50 dark:bg-zinc-800 dark:border-teal-400 rounded-r-lg">
    <h4 className="font-semibold text-teal-700 dark:text-teal-300">AI-Assisted Rapid Prototyping</h4>
    <p className="mt-1 text-zinc-700 dark:text-zinc-300">The power of AI-assisted development is incredible for rapid prototyping, but to build something remotely complex, you still need your own technical skills to understand what is being generated and how to integrate the code best.</p>
  </div>
  
  <div className="p-4 border-l-4 border-blue-500 bg-blue-50 dark:bg-zinc-800 dark:border-blue-400 rounded-r-lg">
    <h4 className="font-semibold text-blue-700 dark:text-blue-300">AI Has Limitations</h4>
    <p className="mt-1 text-zinc-700 dark:text-zinc-300">The AI is not always right, and that's okay! The experiment wasn't to see if the AI could replace me in developing the bot entirely; it was to see how much faster I could work with it assisting itâ€”and the TLDR here is much quicker. There were a lot of minor business logic errors or slight quirks in the output of what was being generated, and simply because I am familiar with the stack, I could easily navigate and steer it back on track or correct it myself.</p>
  </div>
  
  <div className="p-4 border-l-4 border-purple-500 bg-purple-50 dark:bg-zinc-800 dark:border-purple-400 rounded-r-lg">
    <h4 className="font-semibold text-purple-700 dark:text-purple-300">Human Value Still Matters</h4>
    <p className="mt-1 text-zinc-700 dark:text-zinc-300">Ultimately, your project's value and differentiator still come from the personal touch. AI will become the king of scaffolding your BAU applications and workflows, but in this case, the real value was in the trading strategy I implemented outside of the AI, with the AI just building the full orchestration around it.</p>
  </div>
  
  <div className="p-4 border-l-4 border-amber-500 bg-amber-50 dark:bg-zinc-800 dark:border-amber-400 rounded-r-lg">
    <h4 className="font-semibold text-amber-700 dark:text-amber-300">Structured Prompts Are Key</h4>
    <p className="mt-1 text-zinc-700 dark:text-zinc-300">The importance of well-designed structured prompts. Using AI to generate this system wasn't just a single "Hey yeah, let's do this trading system in Firebase, please LFG"; it was broken down into giving a loose architecture first, mapping out the orchestration plan and then developing each component individually (testing along the way for correctness). By doing this, we ended up with a scalable, modular system that can be adapted.</p>
  </div>
</div>

<div className="mt-8 mb-6 p-5 bg-zinc-100 dark:bg-zinc-800 rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-700">
  <h3 className="text-lg font-semibold mb-2 text-zinc-800 dark:text-zinc-200">Future Plans</h3>
  <p>While the current strategy might not be profitable in the long run (I <em>fully</em> expect so, but if that's not the case, I guess I'll get a free beer from it on the weekend), I'll probably take the time going forward to dive into:</p>
  
  <ul className="mt-2 space-y-1 list-disc list-inside text-zinc-700 dark:text-zinc-300">
    <li>More sophisticated trading strategies</li>
    <li>Better risk management features</li>
    <li>Multi-DEX execution capabilities</li>
    <li>Additional market data sources</li>
  </ul>
</div>

<p className="text-lg text-center font-medium text-zinc-600 dark:text-zinc-400 my-8">I hope you enjoyed the read!</p>

<div className="border-t border-zinc-200 dark:border-zinc-700 pt-8 mt-8">
  <h2 className="text-2xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100">Connect</h2>
  
  <div className="flex flex-wrap gap-6 mt-4">
    <a 
      href="https://github.com/galleonlabs" 
      target="_blank" 
      rel="noopener noreferrer"
      className="flex items-center px-4 py-2 bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded-md transition-colors"
    >
      <svg viewBox="0 0 24 24" className="h-5 w-5 mr-2 fill-current text-zinc-700 dark:text-zinc-300" xmlns="http://www.w3.org/2000/svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
      GitHub
    </a>
    
    <a 
      href="https://twitter.com/davyjones0x" 
      target="_blank" 
      rel="noopener noreferrer"
      className="flex items-center px-4 py-2 bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded-md transition-colors"
    >
      <svg viewBox="0 0 24 24" className="h-5 w-5 mr-2 fill-current text-zinc-700 dark:text-zinc-300" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>
      Twitter
    </a>
  </div>
  
  <p className="mt-6 text-zinc-600 dark:text-zinc-400">
    Feel free to reach out if you have any questions or suggestions or want to chat. Until next time, happy coding and trading!
  </p>
</div>